<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>社区首页</title>
    <!-- 设置横屏、竖屏显示，portrait 横屏，landscape 竖屏-->
    <meta name="x5-orientation" content="portrait|landscape">
    <!-- uc强制竖屏 -->
    <meta name="screen-orientation" content="portrait">
    <!-- QQ强制竖屏 -->
    <meta name="x5-orientation" content="portrait">
    <!-- 禁止自动识别日期 -->
    <meta name="format-detection" content="date=no">
    <!-- 禁止自动自动识别 Email -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="email=no">
    <meta name="format-detection" content="telephone=no">
    <!-- 禁止浏览器自动将手机号码变为拨号链接 -->
    <meta name="format-detection" content="address=no">
    <!-- 禁止浏览器自动将地址转换 -->
    <meta name="title" content="">
    <link rel="stylesheet" href="/layui/css/layui.css">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/font_24081_dddajmj0coc4n29.css">
    <link rel="stylesheet" href="/layui/css/modules/layer/default/layer.css">
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

</head>

<body>
    <div class="forum-header">
        <div class="layui-container">
            <a class="logo" href="/index"><img src="/img/logo.png" alt=""></a>

            <div class="fly-column-right layui-hide-xs" style="top:15px;">
                <span class="fly-search LAY_search" style="position:relative;top:8px" id="Search">
					<i class="layui-icon"></i>
                </span>
                <a href="/add" class="layui-btn">发表新帖</a>

            </div>

        </div>
    </div>

    <div class="layui-row layui-col-space15" style="margin-top:20px">
        <div class="layui-container fly-marginTop fly-user-main">
            <ul class="layui-nav layui-nav-tree layui-inline navs" lay-filter="user" style="background:white;">
                <li class="layui-nav-item">
                    <a href="/userinfo.html"> <i class="layui-icon"></i> 我的主页 </a>
                </li>
                <li class="layui-nav-item layui-this">
                    <a href="/user/setting"> <i class="layui-icon"></i> 基本设置 </a>
                </li>
                <li class="layui-nav-item ">
                    <a href="/userTopic.html"> <i class="iconfont icon-tiezi"></i> 我的帖子 </a>
                </li>
                <li class="layui-nav-item ">
                    <a href="/user/message/"> <i class="layui-icon"></i> 我的消息 </a>
                </li>
                <span class="layui-nav-bar" style="top: 212.5px; height: 0px; opacity: 0;"></span>
            </ul>
            <div class="site-tree-mobile layui-hide">
                <i class="layui-icon"></i>
            </div>
            <div class="site-mobile-shade"></div>
            <div class="fly-panel fly-panel-user" pad20="">
                <div class="layui-tab layui-tab-brief" lay-filter="user">
                    <ul class="layui-tab-title" id="LAY_mine">
                        <li class="layui-this" lay-id="info">我的资料</li>
                        <li lay-id="avatar">头像</li>
                        <li lay-id="pass">密码</li>
                    </ul>
                    <div class="layui-tab-content" style="padding: 20px 0;">
                        <div class="layui-form layui-form-pane layui-tab-item layui-show">
                            <#if info??>
                            <form>
                                <div class="layui-form-item">
                                    <label for="L_email" class="layui-form-label">邮箱</label>
                                    <div class="layui-input-inline">
                                        <input type="text" id="L_email" name="email" required="" lay-verify="email" autocomplete="off" value="${info.email}" class="layui-input" />
                                    </div>

                                </div>
                                <div class="layui-form-item">
                                    <label for="L_username" class="layui-form-label">昵称</label>
                                    <div class="layui-input-inline">
                                        <input type="text" id="L_username" name="name" required="" lay-verify="required" autocomplete="off" value="${info.name}" class="layui-input" />
                                    </div>

                                </div>
                                <div class="layui-form-item">
                                    <label for="L_city" class="layui-form-label">城市</label>
                                    <div class="layui-input-inline">
                                        <input type="text" id="L_city" name="city" autocomplete="off" placeholder="请输入你所在的城市" class="layui-input" value="${info.city!}"/>
                                    </div>
                                </div>
                                <div class="layui-form-item layui-form-text">
                                    <label for="L_sign" class="layui-form-label">签名</label>
                                    <div class="layui-input-block">
                                        <textarea placeholder="随便写些什么刷下存在感" id="L_sign" name="signature" autocomplete="off" class="layui-textarea" style="height: 80px;">${info.signature}</textarea>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <button class="layui-btn" key="set-mine" lay-filter="info" lay-submit="" type="button">确认修改</button>
                                </div>
                            </form>
                            </#if>
                        </div>
                        <div class="layui-form layui-form-pane layui-tab-item">
                            <div class="layui-form-item">
                                <div class="avatar-add">
                                    <p>建议尺寸168*168，支持jpg、png、gif，最大不能超过50KB</p>
                                    <button type="button" class="layui-btn upload-img" id="upload"> <i class="layui-icon"></i>上传头像 </button>
                                    <input class="layui-upload-file" type="file" name="file" />
                                    <#if info??>
                                        <img src="${info.avatar!'/img/ch1st.jpg'}" id="avatar"/>
                                    </#if>
                                    <span class="loading"></span>
                                </div>
                            </div>
                        </div>
                        <div class="layui-form layui-form-pane layui-tab-item">
                            <div class="layui-form-item">
                                <label  class="layui-form-label">旧密码</label>
                                <div class="layui-input-inline">
                                    <input type="password" name="oldPass" required placeholder="请输入当前密码" class="layui-input" autocomplete="off"/>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label for="L_pass" class="layui-form-label">新密码</label>
                                <div class="layui-input-inline">
                                    <input type="password" id="L_pass" required="" lay-verify="required|pwd" autocomplete="off" class="layui-input" />
                                </div>
                                <div class="layui-form-mid layui-word-aux">
                                    6到16个字符
                                </div>
                            </div>

                            <div class="layui-form-item">
                                <label for="L_repass" class="layui-form-label">确认密码</label>
                                <div class="layui-input-inline">
                                    <input type="password" id="L_repass" name="newPass" required="" lay-verify="required|rePwd" autocomplete="off" class="layui-input" />
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <button class="layui-btn" key="set-mine" lay-filter="updatePass" lay-submit="">确认修改</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>



    <div class="fly-footer">
        <p>
            <a href="http://fly.layui.com/">社区</a> 2018 &copy;
            <a href="http://www.oldc.pro/">oldc.pro</a>
        </p>
        <p>
            <a href="http://fly.layui.com/jie/3147/" target="_blank">关于我们</a>
            <a href="https://fly.layui.com/case/2018/" target="_blank">layui案例</a> <a href="http://www.layui.com/template/fly/" target="_blank">获取Fly社区模版</a> <a href="http://fly.layui.com/jie/2461/" target="_blank">微信公众号</a> </p>
        <p class="fly-union">
            <a href="https://www.upyun.com/?from=layui" target="_blank" rel="nofollow" upyun=""><img src="./Fly - layui前端框架官方社区_files/upyun.png" /></a> <span>提供 CDN 赞助</span> </p>
    </div>
    <script src="/layui/layui.js"></script>

    <script src="/layui/lay/modules/layer.js"></script>
    <script src="/js/index.js"></script>
    <script>
        layui.use(['element','form','upload'], function() {
            var element = layui.element; //导航的hover效果、二级菜单等功能，需要依赖element模块
            var form =layui.form;
            var upload=layui.upload;
            var $ =layui.jquery;
            //监听导航点击
            element.on('nav(demo)', function(elem) {
                //console.log(elem)
                layer.msg(elem.text());
            });
            form.on('submit(info)',function(data){
               $.ajax({
                    url:'/user/updateInfo'
                    ,type:'PATCH'
                    ,contentType:'application/json'
                    ,data:JSON.stringify(data.field)
                    ,success:function(result){
                        layer.msg(result.msg);
                   }
               });
            });
            form.verify({
                user: [
                    /^[a-zA-Z0-9_\u4e00-\u9fa5\\s·]+$/, "用户名不能出现特殊字符"
                ],

                pwd: function(value, item) {
                    if (value === "") {
                        return "密码不能为空";
                    }
                    var Digital = /\d/;
                    var Letters = /[a-zA-Z]/;
                    if (!(Digital.test(value) && Letters.test(value) && value.length >= 0)) {
                        return '密码必须含有字母和数字';
                    }
                },
                rePwd: function(value, item) {
                    if (value === "") {
                        return "请输入二次密码";
                    }
                    var pwd = $("#L_pass").val();
                    if (pwd != value) {
                        return '密码与确认密码不正确';
                    }
                    var origin=$("input[name='oldPass']").val();
                    if(origin==value){
                        return '新密码不能与旧密码相同';
                    }

                }
            });
            form.on('submit(updatePass)',function(data){
               $.ajax({
                  url:'/user/changePwd'
                  ,type:'PATCH'
                  ,contentType:'application/json'
                  ,data:JSON.stringify(data.field)
                  ,success:function(result){
                      layer.msg(result.msg);
                   }
               });
            });
            var uploadInst = upload.render({
                elem:"#upload"
                ,url:"/uploadImg"
                ,before:function(obj){
                    obj.preview(function(index,file,result){
                       $("#avatar").attr('src',result);
                    });
                }
                ,done:function(res){
                    return layer.msg(res.msg);
                }
            });
        });
    </script>

</body>

</html>